#!/bin/bash -x

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

blacklist_regex=${2:-'^(MAXMIND_DOWNLOAD_URL)$'}
blacklist_regex=${3:-''}
if [ -d "$ENV_DIR" ]; then
  for e in $(ls $ENV_DIR); do
    echo "$e" | grep -E "$whitelist_regex" | grep -qvE "$blacklist_regex" &&
    export "$e=$(cat $ENV_DIR/$e)"
    :
  done
fi


echo "Downloading databases"

for i in ASN-CSV.zip City.tar.gz; do
  ( cd $BUILD_DIR/tmp && curl -s -O "$MAXMIND_DOWNLOAD_URL/GeoLite2-$i" )
done

echo "Extracting databases"

ENTRY=$( cd $BUILD_DIR/tmp && tar -ztpf GeoLite2-City.tar.gz | grep GeoLite2-City.mmdb )
( cd $BUILD_DIR/tmp && tar --strip-components 1 -xvpf GeoLite2-City.tar.gz $ENTRY )

ENTRY=$( cd $BUILD_DIR/tmp && unzip -l GeoLite2-ASN-CSV.zip  | grep csv | awk '{print $4}' )
echo $ENTRY
( cd $BUILD_DIR/tmp && unzip Geolite2-ASN-CSV.zip $ENTRY )
( cd $BUILD_DIR/tmp && cp $ENTRY . )
